"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var _regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),_toConsumableArray=_interopDefault(require("@babel/runtime/helpers/toConsumableArray")),inquirer=require("inquirer"),os=require("os"),ini=require("ini"),fs=require("fs"),child_process=require("child_process"),_objectSpread=_interopDefault(require("@babel/runtime/helpers/objectSpread")),_defineProperty=_interopDefault(require("@babel/runtime/helpers/defineProperty")),joi=require("joi"),chalk=require("chalk"),cmd=_interopDefault(require("commander"));function multipleChoicePrompt(e,t,r){return inquirer.prompt([{type:"list",message:e,name:t,choices:_toConsumableArray(r)}])}function listProfiles(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=Object.keys(e).filter(removeFilteredKeyword);return t&&(r=r.map(removeProfilePrefix)),r}function removeFilteredKeyword(e){return e.match(/^(profile-)(.*)(?<!-temp)$/i)}function removeProfilePrefix(e){return e.replace(/^profile-/,"")}function profileListPrompt(e){return multipleChoicePrompt("Pick a profile: ","profile",listProfiles(e,!0))}function inputPrompt(e,t){return inquirer.prompt([{type:"type",message:e,name:t}])}function inputMFAPrompt(e){return e=e?e.trim():e,inputPrompt("Enter MFA token (6 digits) for profile ".concat(e,": "),"mfaToken")}function getAwsCredentialPath(){return"win32"===os.platform()?os.homedir()+"/.aws/credentials":"linux"===os.platform()?os.homedir()+"/.aws/credentials":void 0}function loadCredentials(){var e=fs.readFileSync(getAwsCredentialPath(),"utf-8");return ini.parse(e)}function getAssumableRolePrefixes(e){return e.map(function(e){return e.replace("profile-","")})}function matchProfile(r){return"profile-"+getAssumableRolePrefixes(listProfiles(loadCredentials())).find(function(e){var t=new RegExp("^".concat(e));return r.match(t)})}function executeCommand(e,n,o){return child_process.exec(e,function(e,t,r){return e&&e.killed?o(e):r?o(r):n(t)})}function get(r){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return new Promise(function(e,t){return executeCommand("aws configure get ".concat(r," ").concat(n),e,t)})}function getMFASerial(e){return get("mfa_serial","--profile ".concat(e))}function getSessionToken(r){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;return r=r.trim(),n||o?(n=n.trim(),o=o.trim(),new Promise(function(e,t){executeCommand("aws sts get-session-token --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --serial-number ".concat(n," --token-code ").concat(o," --profile ").concat(r," --output json"),e,t)})):new Promise(function(e,t){executeCommand("aws sts get-session-token --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --profile ".concat(r," --output json"),e,t)})}function setCredentials(e){var t=fs.readFileSync(getAwsCredentialPath(),"utf-8"),r=_objectSpread({},ini.parse(t),e);return fs.writeFileSync(getAwsCredentialPath(),ini.stringify(r))}function clearDefaultCredential(){return setCredentials({default:{}})}function set(r,n){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";return new Promise(function(e,t){return executeCommand("aws configure set ".concat(r," ").concat(n," ").concat(o),e,t)})}function setTemporaryCredentials(e,t,r,n){return _setTemporaryCredentials.apply(this,arguments)}function _setTemporaryCredentials(){return(_setTemporaryCredentials=_asyncToGenerator(_regeneratorRuntime.mark(function e(t,r,n,o){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,set("aws_access_key_id",t);case 2:return e.next=4,set("aws_secret_access_key",r);case 4:return e.next=6,set("aws_access_key_id",t,"--profile ".concat(o,"-temp"));case 6:return e.next=8,set("aws_secret_access_key",r,"--profile ".concat(o,"-temp"));case 8:if(n)return e.next=11,set("aws_session_token",n);e.next=13;break;case 11:return e.next=13,set("aws_session_token",n,"--profile ".concat(o,"-temp"));case 13:case"end":return e.stop()}},e)}))).apply(this,arguments)}function list(){return new Promise(function(e,t){return executeCommand("aws configure list",e,t)})}function switchProfile(){return _switchProfile.apply(this,arguments)}function _switchProfile(){return(_switchProfile=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var t,r,n,o,i,a,s,c=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!(0<c.length&&void 0!==c[0])||c[0],clearDefaultCredential(),r=loadCredentials(),e.next=5,profileListPrompt(r);case 5:return n=e.sent,o=matchProfile(o=n.profile),e.next=10,getMFASerial(o);case 10:if(i=e.sent,t||i){e.next=19;break}return a=r[o],e.next=15,setTemporaryCredentials(a.aws_access_key_id,a.aws_secret_access_key,void 0,o);case 15:return e.next=17,list();case 17:s=e.sent,console.log(s);case 19:case"end":return e.stop()}},e)}))).apply(this,arguments)}function inputProfileNamePrompt(){return inputPrompt("Enter profile name: ","profileName")}function inputAwsAccessKeyIdPrompt(e){return e=e?e.trim():e,inputPrompt("Enter AWS access key id for ".concat(e,": "),"accessKeyId")}function inputAwsRegionPrompt(e){return e=e?e.trim():e,inputPrompt("Enter region for ".concat(e,": "),"region")}function inputAwsSecretPrompt(e){return e=e?e.trim():e,inputPrompt("Input AWS secret access key for ".concat(e,": "),"secretAccessKey")}function inputMFASerialPrompt(e){return e=e?e.trim():e,inputPrompt("Enter MFA serial for ".concat(e,": "),"mfaSerial")}function createProfileTransformer(e){var t=e.profileName,r=e.region,n=e.secretAccessKey,o=e.mfaSerial,i=e.accessKeyId,a=_defineProperty({},"profile-"+t,{region:r,aws_secret_access_key:n,aws_access_key_id:i});return o&&(a["profile-"+t].mfa_serial=o),a}var validationSchema=joi.object().keys({profileName:joi.string().trim().required(),region:joi.string().trim().required(),secretAccessKey:joi.string().trim().required(),accessKeyId:joi.string().trim().required(),mfaSerial:joi.string().trim().optional()});function createProfileValidation(e){return joi.validate(e,validationSchema,{abortEarly:!1})}function createProfile(){return _createProfile.apply(this,arguments)}function _createProfile(){return(_createProfile=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var t;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=_objectSpread,e.t1={},e.next=4,inputProfileNamePrompt();case 4:return e.t2=e.sent,t=(0,e.t0)(e.t1,e.t2),e.t3=_objectSpread,e.t4={},e.t5=t,e.next=11,inputAwsAccessKeyIdPrompt(t.profileName);case 11:return e.t6=e.sent,e.next=14,inputAwsRegionPrompt(t.profileName);case 14:return e.t7=e.sent,e.next=17,inputAwsSecretPrompt(t.profileName);case 17:return e.t8=e.sent,e.next=20,inputMFASerialPrompt(t.profileName);case 20:return e.t9=e.sent,t=(0,e.t3)(e.t4,e.t5,e.t6,e.t7,e.t8,e.t9),e.next=24,createProfileValidation(t);case 24:setCredentials(createProfileTransformer(t=e.sent)),console.log(chalk.green("".concat(t.profileName," has been added to credentials file")));case 27:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getRegion(e){return get("region","--profile ".concat(e))}function inputRoleNamePrompt(){return inputPrompt("Enter role name: ","roleName")}function inputAwsRoleArnPrompt(e){return e=e?e.trim():e,inputPrompt("Enter role arn for ".concat(e,": "),"roleArn")}function createRoleTransformer(e){var t=e.roleName,r=e.profile,n=e.roleArn,o=e.region;return _defineProperty({},"".concat(r,"-").concat(t),{source_profile:"profile-".concat(r,"-temp"),output:"json",region:o.trim(),role_arn:n.trim()})}function createRole(){return _createRole.apply(this,arguments)}function _createRole(){return(_createRole=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var t,r;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=loadCredentials(),e.t0=_objectSpread,e.t1={},e.next=5,inputRoleNamePrompt();case 5:return e.t2=e.sent,r=(0,e.t0)(e.t1,e.t2),e.t3=_objectSpread,e.t4={},e.t5=r,e.next=12,profileListPrompt(t);case 12:return e.t6=e.sent,r=(0,e.t3)(e.t4,e.t5,e.t6),e.t7=_objectSpread,e.t8={},e.t9=r,e.next=19,inputAwsRoleArnPrompt(r.roleName);case 19:return e.t10=e.sent,r=(0,e.t7)(e.t8,e.t9,e.t10),e.t11=_objectSpread,e.t12={},e.t13=r,e.next=26,getRegion("profile-".concat(r.profile));case 26:e.t14=e.sent,e.t15={region:e.t14},setCredentials(createRoleTransformer(r=(0,e.t11)(e.t12,e.t13,e.t15))),console.log(chalk.green("".concat(r.roleName," for profile ").concat(r.profile," has been added to credentials file")));case 31:case"end":return e.stop()}},e)}))).apply(this,arguments)}function listAssumableRoles(e){return Object.keys(e).filter(removeFilteredKeyword$1)}function removeFilteredKeyword$1(e){return e.match(/^(?!profile|default)/i)}function assumableRolesPrompt(e){return multipleChoicePrompt("Pick a role to assume: ","assumedRole",listAssumableRoles(e))}function getUser(r){return new Promise(function(e,t){executeCommand("aws iam get-user --query User.UserName --output text --profile ".concat(r),e,t)})}function getSourceProfile(r){return new Promise(function(e,t){return executeCommand("aws configure get source_profile --profile ".concat(r),e,t)})}function assumeRole(r,n){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";return r=r.trim(),n=n.trim(),new Promise(function(e,t){executeCommand("aws sts assume-role --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --role-arn ".concat(r," --role-session-name cli-").concat(n," ").concat(o," --output json"),e,t)})}function assumeAwsRole(e,t){return _assumeAwsRole.apply(this,arguments)}function _assumeAwsRole(){return(_assumeAwsRole=_asyncToGenerator(_regeneratorRuntime.mark(function e(t,r){var n,o;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,getSourceProfile(t);case 2:return n=e.sent,e.next=5,getUser(n);case 5:return o=e.sent,e.abrupt("return",assumeRole(r,o,"--profile ".concat(n.trim())));case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getRoleArn(e){return get("role_arn","--profile ".concat(e))}function setDefaultCredential(e,t,r){return _setDefaultCredential.apply(this,arguments)}function _setDefaultCredential(){return(_setDefaultCredential=_asyncToGenerator(_regeneratorRuntime.mark(function e(t,r,n){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,set("aws_access_key_id",t);case 2:return e.next=4,set("aws_secret_access_key",r);case 4:return e.next=6,set("aws_session_token",n);case 6:case"end":return e.stop()}},e)}))).apply(this,arguments)}function switchRole(){return assumableRolesPrompt(loadCredentials()).then(function(){var t=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var r,n,o,i,a,s,c,u,l,p,f;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.assumedRole,n=matchProfile(r),e.next=4,getMFASerial(n);case 4:return o=e.sent,e.next=7,getRoleArn(r);case 7:return i=e.sent,e.prev=8,e.next=11,assumeAwsRole(r,i);case 11:return a=e.sent,a=JSON.parse(a),e.next=15,setDefaultCredential(a[0],a[1],a[2]);case 15:return e.next=17,list();case 17:s=e.sent,console.log(s),console.log(chalk.green("[".concat(r,"]: Assumed role associated with profile ").concat(n))),e.next=55;break;case 22:if(e.prev=22,e.t0=e.catch(8),e.t0.match(/(InvalidClientTokenId)|(ExpiredToken)/)){e.next=27;break}return console.log("Something went wrong, contact developer."),e.abrupt("return");case 27:if(o)return e.next=30,inputMFAPrompt(n);e.next=37;break;case 30:return l=e.sent,c=l.mfaToken,e.next=34,getSessionToken(n,o,c);case 34:u=e.sent,e.next=40;break;case 37:return e.next=39,getSessionToken(n);case 39:u=e.sent;case 40:return u=JSON.parse(u),e.next=43,setTemporaryCredentials(u[0],u[1],u[2],n);case 43:return console.log(chalk.green("Enabled temporary session for profile ".concat(n," as default and ").concat(n,"-temp"))),e.next=46,assumeAwsRole(r,i);case 46:return p=e.sent,p=JSON.parse(p),e.next=50,setDefaultCredential(p[0],p[1],p[2]);case 50:return e.next=52,list();case 52:f=e.sent,console.log(f),console.log(chalk.green("[".concat(r,"]: Assumed role associated with profile ").concat(n)));case 55:case"end":return e.stop()}},e,null,[[8,22]])}));return function(e){return t.apply(this,arguments)}}())}function menuPrompt(e){return multipleChoicePrompt("Main menu: ","menu",e)}var menuItems=[{name:"New profile",value:createProfile},{name:"New Role",value:createRole},{name:"Switch profile",value:switchProfile},{name:"Switch profile (No Token)",value:function(){return switchProfile(!1)}},{name:"Switch role",value:switchRole}];function menu(e){return _menu.apply(this,arguments)}function _menu(){return(_menu=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var r;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return menuItems.push({name:"Show help",value:t}),e.next=3,menuPrompt(menuItems);case 3:return r=e.sent,e.abrupt("return",r.menu());case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}var packageMeta=require("../package.json");cmd.version(packageMeta.version,"-v, --version").option("-R, --add-role","Add new AWS Role",createRole).option("-P, --add-profile","Add new AWS Profile",createProfile).option("-r, --switch-role","Switch AWS Role",switchRole).option("-p, --switch-profile","Switch AWS Profile",switchProfile),process.argv.slice(2).length||menu(cmd.outputHelp),cmd.parse(process.argv);
